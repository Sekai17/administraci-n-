<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Administración v1.3 · Artículos</title><style>html,body{margin:0;height:100%;font:500 15px/1.35 system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#101114;background:#f6f7fb}*{box-sizing:border-box}a{color:inherit}button,input,select,textarea{font:inherit}header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(1.2) blur(6px);background:rgba(255,255,255,.88);border-bottom:1px solid #e6e8ef}#bar{max-width:1200px;margin:auto;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px}#tabs{display:flex;gap:6px}#tabs button{border:1px solid #d7dbeb;background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;transition:.18s}#tabs button[aria-selected=true]{background:#101114;color:#fff;border-color:#101114}#bar .tools{display:flex;gap:6px;align-items:center}#help,.btn{border:1px solid #101114;background:#101114;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}#logout{border:1px solid #d33;background:#d33;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}#main{max-width:1200px;margin:18px auto;padding:0 12px;display:grid;gap:14px}section{display:none}section.active{display:block}form{display:grid;gap:8px}fieldset{border:1px solid #e6e8ef;border-radius:12px;padding:10px;background:#fff}legend{padding:0 6px}label{display:grid;gap:4px}input[type=text],input[type=number],input[type=url],input[type=date],textarea,select{width:100%;border:1px solid #d7dbeb;border-radius:10px;padding:10px 12px;background:#fff}textarea{resize:vertical;min-height:64px;max-height:180px}#row{display:grid;grid-template-columns:1fr;gap:10px}#actions{display:flex;flex-wrap:wrap;gap:8px}#actions .ghost,.btn.ghost{background:#fff;color:#101114}#msg{min-height:20px;color:#c01616}table{width:100%;border-collapse:separate;border-spacing:0 6px}thead th{text-align:left;font-weight:700;color:#3b3f56;padding:6px 8px}tbody td{background:#fff;border:1px solid #e6e8ef;border-left:0;border-right:0;padding:10px}tbody tr{box-shadow:0 6px 20px rgba(0,0,0,.05);border-radius:10px}tbody tr td:first-child{border-left:1px solid #e6e8ef;border-top-left-radius:10px;border-bottom-left-radius:10px}tbody tr td:last-child{border-right:1px solid #e6e8ef;border-top-right-radius:10px;border-bottom-right-radius:10px}tr.grp td{background:#eef1f7!important;border-color:#eef1f7!important;font-weight:700;color:#3b3f56}td .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}td .tag{font-size:12px;background:#eef1f7;border:1px solid #dfe3ef;border-radius:999px;padding:4px 8px}td .warn{background:#fff3cd;border-color:#ffe69c}td .ok{background:#e3f8e8;border-color:#cef1d5}td .bad{background:#fbe3e3;border-color:#f3c9c9}td .act{display:flex;gap:6px}td .act button{padding:8px 12px;border-radius:8px;border:1px solid #d7dbeb;background:#fff;cursor:pointer}#filters{display:flex;flex-wrap:wrap;gap:8px;align-items:center}#filters input,#filters select{padding:10px 12px;border-radius:10px;border:1px solid #d7dbeb;background:#fff}#imgs{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px}#imgs .it{position:relative;border:1px solid #e6e8ef;border-radius:10px;overflow:hidden;background:#fff;display:grid;gap:4px;padding:6px}#imgs img{width:100%;height:82px;object-fit:cover;border-radius:8px}#imgs .it .top{display:flex;justify-content:space-between;align-items:center}#imgs .rm{border:0;background:#101114;color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer}#dirpick{display:grid;gap:6px}#dirlist{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px}#dirlist label{border:1px dashed #d7dbeb;border-radius:10px;padding:8px;display:grid;gap:6px;align-items:start;background:#fff}#dirlist img{width:100%;height:100px;object-fit:cover;border-radius:8px}#mov-head{display:flex;flex-wrap:wrap;gap:10px;align-items:center}#quick button{border:1px solid #d7dbeb;background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}#sum{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}#sum .card{background:#fff;border:1px solid #e6e8ef;border-radius:12px;padding:12px;display:grid;gap:6px}#stockres{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}#stockres .card{background:#fff;border:1px solid #e6e8ef;border-radius:12px;padding:12px}.hide{display:none}.dup td{outline:2px dashed #f3c353}.sel td{outline:2px solid #101114}#toast{position:fixed;right:14px;bottom:14px;z-index:50;display:grid;gap:6px;max-width:min(90vw,360px)}.toast{background:#101114;color:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 12px 40px rgba(0,0,0,.25);opacity:.98}#guide{position:fixed;inset:0;background:rgba(16,17,20,.42);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:40}#guide .card{max-width:720px;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;display:grid;gap:10px}#guide .card h3{margin:0}#guide .steps{display:grid;gap:8px}#guide .steps div{display:flex;gap:8px;align-items:flex-start}#guide .steps b{min-width:24px;height:24px;display:grid;place-items:center;border-radius:999px;background:#101114;color:#fff}#closeG{justify-self:end;border:1px solid #101114;background:#101114;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}#import{position:fixed;inset:0;background:rgba(16,17,20,.42);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:40}#import .card{width:min(96vw,920px);max-height:90vh;overflow:auto;background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;display:grid;gap:10px}#mapBox{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}#impPrev{overflow:auto;border:1px solid #e6e8ef;border-radius:10px}#impPrev table{border-collapse:collapse;width:100%}#impPrev th,#impPrev td{border:1px solid #eee;padding:6px;font-size:13px}#pager{display:none;gap:8px;align-items:center;justify-content:flex-end;margin:8px 0}#pager>button{border:1px solid #d7dbeb;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}#pager select{border:1px solid #d7dbeb;border-radius:10px;padding:8px 12px;background:#fff}#auth{position:fixed;inset:0;background:linear-gradient(180deg,rgba(16,17,20,.5),rgba(16,17,20,.6));display:grid;place-items:center;z-index:100}#auth .card{width:min(96vw,420px);background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:16px;display:grid;gap:10px}#auth h3{margin:0}#auth form{display:grid;gap:8px}#auth .row{display:flex;gap:8px;align-items:center;justify-content:space-between}#auth .small{font-size:12px;opacity:.75}@media(min-width:940px){#row{grid-template-columns:1.1fr .9fr}}</style></head><body><header><div id=bar><div id=tabs role=tablist><button id=tabCargar role=tab aria-selected=true data-hint="Sección Cargar">➕ Cargar</button><button id=tabSalida role=tab aria-selected=false data-hint="Sección Salida">📦 Salida</button></div><div class=tools><button id=btnImport class=btn title="Importar CSV/JSON" data-hint="Importa y mapea columnas">⬆️ Importar</button><button id=btnExportAll class=btn title="Exportar catálogo JSON" data-hint="Exporta todo el catálogo">⬇️ Catálogo JSON</button><button id=help class=btn title="Guía rápida" data-hint="Abre mini guía">❓ Guía</button><button id=logout title="Cerrar sesión">🔒 Salir</button></div></div></header><main id=main><section id=secCargar class=active><div id=row><form id=fm aria-labelledby=tabCargar><fieldset><legend>Artículo</legend><label>Nombre<input id=nombre type=text required autocomplete=off placeholder="Ej: Remera Básica"></label><label>Categoría<input id=categoria type=text list=dlcats autocomplete=off placeholder="Ej: Indumentaria"></label><datalist id=dlcats></datalist><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px"><label>Precio de venta (ARS)<input id=precio type=number inputmode=decimal min=0 step=.01 required placeholder="0,00"></label><label>Costo (opcional)<input id=costo type=number inputmode=decimal min=0 step=.01 placeholder="0,00"></label><label>Stock actual<input id=stock type=number inputmode=numeric min=0 step=1 required placeholder="0"></label><label>Estado<select id=estado><option value=1 selected>Activo</option><option value=0>Inactivo</option></select></label></div><label>Descripción corta (≤160)<textarea id=desc maxlength=160 placeholder="Texto breve que verán los clientes"></textarea></label><label>Slug<input id=slug type=text readonly></label></fieldset><fieldset><legend>Imágenes</legend><div class=row style="display:flex;flex-wrap:wrap;gap:8px;align-items:center"><label class=btn data-hint="Selecciona imágenes de tu dispositivo"><input id=files type=file accept=image/* multiple class=hide>Subir archivos</label><span>o</span><input id=imgUrl type=url placeholder="https://..."><button id=addUrl type=button class=btn ghost data-hint="Añade imagen por URL">Añadir URL</button><span>o</span><label class=btn data-hint="Elige una carpeta con imágenes"><input id=dir type=file webkitdirectory multiple class=hide>Elegir carpeta</label><button id=addDirSel type=button class=btn ghost disabled data-hint="Agrega las seleccionadas">Agregar seleccionadas</button><button id=clrImgs type=button class=btn ghost data-hint="Vacía la galería">Limpiar</button></div><div id=dirpick class=hide><div id=dirlist></div></div><div id=imgs></div></fieldset><div id=actions><button id=save type=submit data-hint="Guarda el artículo">Guardar</button><button id=clear type=button class=ghost data-hint="Limpia el formulario">Limpiar</button><button id=exportOne type=button class=ghost data-hint="Exporta este artículo">Exportar JSON</button></div><div id=msg role=status aria-live=polite></div><input id=aid type=hidden></form><aside><div class=card style="background:#fff;border:1px solid #e6e8ef;border-radius:12px;padding:10px"><div style=opacity:.7>Atajos</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px"><button type=button class=btn ghost id=dupCheck data-hint="Agrega sufijo al nombre">Añadir sufijo</button><button type=button class=btn ghost id=slugBtn data-hint="Regenera el slug">Regenerar slug</button></div><div style="margin-top:8px;font-size:13px;opacity:.75">Enter guarda. ↑↓ navega tabla y Enter edita.</div></div></aside></div></section><section id=secSalida><div id=filters><input id=q type=text placeholder="Buscar..." autocomplete=off><select id=fcat><option value="">Todas las categorías</option></select><select id=fest><option value="">Todos</option><option value=1>Activos</option><option value=0>Inactivos</option></select><button id=csvArt class=btn ghost type=button data-hint="Exporta artículos a CSV">CSV Artículos</button><button id=csvMov class=btn ghost type=button data-hint="Exporta movimientos a CSV">CSV Movimientos</button></div><div style=overflow:auto><table id=tbl><thead><tr><th>Nombre</th><th>Categoría</th><th>Stock</th><th>Precio</th><th>Creación</th><th>Imágenes</th><th>Estado</th><th>Acciones</th></tr></thead><tbody></tbody></table></div><div id=pager><button id=pgPrev>◀</button><div id=pgInfo>—</div><button id=pgNext>▶</button><select id=pageSize><option>50</option><option selected>100</option><option>200</option></select></div><div style=margin:8px 0;display:flex;gap:8px;flex-wrap:wrap><span class=tag warn id=dupBadge style=display:none>Duplicados detectados</span></div><hr><div id=mov-head><h3 style=margin:0>Stock/Ventas</h3><div id=quick><button data-per=day data-hint="Filtra hoy">Hoy</button><button data-per=week data-hint="Filtra última semana">Últ. semana</button><button data-per=month data-hint="Filtra último mes">Últ. mes</button></div><div class=row style="display:flex;gap:6px;align-items:center"><label>Desde<input id=dfrom type=date></label><label>Hasta<input id=dto type=date></label><button id=applyPer class=btn ghost data-hint="Aplica rango">Aplicar</button></div></div><div style="display:grid;gap:10px;margin-top:8px"><form id=fmov style="display:grid;gap:6px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))"><select id=movArt required></select><select id=movTipo><option value=venta>venta</option><option value=ingreso>ingreso</option></select><input id=movCant type=number min=1 step=1 placeholder=Cantidad required><input id=movPU type=number min=0 step=.01 placeholder="Precio unitario" required><input id=movDate type=date required><button class=btn data-hint="Registra el movimiento">Registrar</button><div id=movMsg style=color:#c01616></div></form><div id=sum><div class=card><div style=opacity:.7>Ventas (período)</div><div id=sVenta>—</div></div><div class=card><div style=opacity:.7>Ingresos (período)</div><div id=sIngreso>—</div></div><div class=card><div style=opacity:.7>Hoy</div><div id=tHoy>—</div></div><div class=card><div style=opacity:.7>Semana</div><div id=tSem>—</div></div><div class=card><div style=opacity:.7>Mes</div><div id=tMes>—</div></div></div><div style=display:grid;gap:6px><div style=font-weight:700>Movimientos</div><div style=overflow:auto><table id=tmov><thead><tr><th>Fecha</th><th>Tipo</th><th>Artículo</th><th>Cant.</th><th>PU</th><th>Total</th></tr></thead><tbody></tbody></table></div></div><div style=display:grid;gap:6px><div style=font-weight:700>Stock resultante por artículo</div><div id=stockres></div></div></div></section></main><div id=toast></div><div id=guide><div class=card><h3>Guía rápida</h3><div class=steps><div><b>1</b><div><u>Cargar</u>: completa campos mínimos. El <i>slug</i> se genera solo.</div></div><div><b>2</b><div><u>Imágenes</u>: subí archivos, URL o carpeta. Marcá una como Principal.</div></div><div><b>3</b><div><u>Guardar</u>: aparece en <i>Salida</i>. Editar/duplicar/eliminar.</div></div><div><b>4</b><div><u>Stock/Ventas</u>: registra ingresos/ventas; totales por período.</div></div><div><b>5</b><div><u>Importar</u>: CSV/JSON, mapeo de columnas, opción actualizar duplicados.</div></div><div><b>6</b><div><u>Exportar</u>: catálogo JSON o CSV de artículos/movimientos.</div></div></div><button id=closeG>Cerrar</button></div></div><div id=import><div class=card><div style="display:flex;gap:8px;align-items:center;justify-content:space-between"><div style=font-weight:700>Importar CSV/JSON</div><button id=impClose class=btn>✕</button></div><div style="display:grid;gap:8px"><input id=impFile type=file accept=.csv,.json><div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"><label>Delimitador<select id=impDelim><option value="," selected>,</option><option value=";">;</option><option value="\t">Tab</option></select></label><label><input type=checkbox id=impUpdate> Actualizar si existe</label><button id=impDetect class=btn>Detectar columnas</button><button id=impDo class=btn>Importar</button></div><div id=mapBox></div><div id=impPrev></div></div></div></div><div id=auth><div class=card><h3 id=authTitle>Configurar administrador</h3><form id=authSetup><label>Usuario<input id=au type=text minlength=3 required placeholder="usuario"></label><label>Contraseña<input id=ap type=password minlength=6 required placeholder="••••••"></label><label>Repetir<input id=ap2 type=password minlength=6 required placeholder="••••••"></label><button class=btn>Crear</button></form><form id=authLogin class=hide><label>Usuario<input id=lu type=text required></label><label>Contraseña<input id=lp type=password required></label><div class=row><label class=small><input type=checkbox id=remember> Recordarme 7 días</label><button id=doLogin class=btn>Entrar</button></div><div id=la class=small style=color:#d33></div></form><div class=small>Protección local. Para seguridad real usá servidor o capa de acceso.</div></div></div><script>const $=q=>document.querySelector(q),$$=q=>Array.from(document.querySelectorAll(q));const S_ART="adm_articulos",S_MOV="adm_movimientos";let ART=JSON.parse(localStorage.getItem(S_ART)||"[]"),MOV=JSON.parse(localStorage.getItem(S_MOV)||"[]"),editing=null,imgBuf=[],dirBuf=[],CUR={page:1,visIds:[]};const today=()=>{const d=new Date();return d.toISOString().slice(0,10)},fmtMoney=v=>new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS"}).format(+v||0),fmtDate=d=>{const x=new Date(d);return("0"+x.getDate()).slice(-2)+"/"+("0"+(x.getMonth()+1)).slice(-2)+"/"+x.getFullYear()},slugify=s=>s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");const uuid=()=>crypto.randomUUID?crypto.randomUUID():([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));const saveART=()=>localStorage.setItem(S_ART,JSON.stringify(ART)),saveMOV=()=>localStorage.setItem(S_MOV,JSON.stringify(MOV));const toastC=$('#toast');function toast(t){const el=document.createElement('div');el.className='toast';el.textContent=t;toastC.appendChild(el);setTimeout(()=>{el.style.opacity=.0;setTimeout(()=>el.remove(),230)},1500)}function setTab(id){$(`#secCargar`).classList.toggle("active",id=="c"),$(`#secSalida`).classList.toggle("active",id=="s"),$(`#tabCargar`).setAttribute("aria-selected",id=="c"),$(`#tabSalida`).setAttribute("aria-selected",id=="s");toast(id=="c"?"Cargar":"Salida")}tabCargar.onclick=()=>{setTab("c");hint(tabCargar)};tabSalida.onclick=()=>{setTab("s");renderList();renderMovUI();hint(tabSalida)};function msg(t){msgEl.textContent=t;clearTimeout(msg.t);msg.t=setTimeout(()=>msgEl.textContent="",2000)}const msgEl=$('#msg');$('#nombre').addEventListener('input',e=>{$('#slug').value=slugify(e.target.value)});$('#slugBtn').onclick=()=>{$('#slug').value=slugify($('#nombre').value||"");hint(slugBtn)};$('#dupCheck').onclick=()=>{$('#nombre').value=$('#nombre').value?$('#nombre').value+" ("+(Math.floor(Math.random()*90)+10)+")":"";$('#slug').value=slugify($('#nombre').value);hint(dupCheck)};function ensureCats(){const cats=[...new Set(ART.map(a=>a.categoria).filter(Boolean))].sort();$('#dlcats').innerHTML=cats.map(c=>`<option value="${c}">`).join('');$('#fcat').innerHTML='<option value="">Todas las categorías</option>'+cats.map(c=>`<option>${c}</option>`).join('')}ensureCats();function renderImgs(){const c=$('#imgs');c.innerHTML=imgBuf.map((im,i)=>`<div class=it data-i=${i}><div class=top><label style="display:flex;align-items:center;gap:4px"><input type=radio name=prim ${im.primary?'checked':''} data-k=prim>Principal</label><button class=rm data-k=rm>x</button></div><img src="${im.src}" alt="img"><div style=font-size:12px;opacity:.8>${im.type}</div></div>`).join('');c.onclick=e=>{const p=e.target.closest('.it');if(!p)return;const i=+p.dataset.i;if(e.target.dataset.k=='rm'){imgBuf.splice(i,1);if(!imgBuf.some(x=>x.primary)&&imgBuf[0])imgBuf[0].primary=true;renderImgs();toast('Imagen quitada')}if(e.target.dataset.k=='prim'){imgBuf.forEach((x,j)=>x.primary=j==i);renderImgs();toast('Principal actualizada')}}}function addFileImgs(list){const arr=[...list].filter(f=>f.type.startsWith('image/'));if(!arr.length){msg('Sin imágenes válidas');return}let pending=arr.length;arr.forEach(f=>{const r=new FileReader;r.onload=ev=>{imgBuf.push({src:ev.target.result,type:'dataurl',name:f.name,primary:!imgBuf.some(x=>x.primary)});if(--pending==0){renderImgs();toast('Imágenes añadidas')}};r.readAsDataURL(f)})}files.onchange=e=>{addFileImgs(e.target.files);hint(files.parentElement)};imgUrl.addEventListener('input',e=>{try{new URL(e.target.value);e.target.setCustomValidity('')}catch{e.target.setCustomValidity('URL inválida')}});addUrl.onclick=()=>{const u=imgUrl.value.trim();try{new URL(u)}catch{msg('URL inválida');return}const im=new Image;im.onload=()=>{imgBuf.push({src:u,type:'url',primary:!imgBuf.some(x=>x.primary)});renderImgs();imgUrl.value='';toast('URL añadida');hint(addUrl)};im.onerror=()=>msg('No se pudo cargar');im.referrerPolicy='no-referrer';im.src=u};dir.onchange=e=>{dirBuf=[...e.target.files].filter(f=>f.type.startsWith('image/'));$('#dirpick').classList.remove('hide');$('#dirlist').innerHTML=dirBuf.map((f,i)=>{const url=URL.createObjectURL(f);return `<label><input type=checkbox data-i=${i}><img src="${url}" alt="${f.name}"><div style=font-size:12px>${f.name}</div></label>`}).join('');hint(dir.parentElement)};addDirSel.onclick=()=>{const ids=$$('#dirlist input:checked').map(x=>+x.dataset.i);if(!ids.length){msg('Nada seleccionado');return}addDirSel.disabled=true;let pending=ids.length;ids.forEach(i=>{const f=dirBuf[i],r=new FileReader;r.onload=ev=>{imgBuf.push({src:ev.target.result,type:'dataurl',name:f.name,primary:!imgBuf.some(x=>x.primary)});if(--pending==0){renderImgs();addDirSel.disabled=false;$('#dirpick').classList.add('hide');toast('Imágenes de carpeta')}};r.readAsDataURL(f)})};clrImgs.onclick=()=>{imgBuf=[];renderImgs();toast('Galería limpia');hint(clrImgs)};function formObj(){const nombre=$('#nombre').value.trim(),categoria=$('#categoria').value.trim(),precio=+($('#precio').value||0),costo=$('#costo').value===''?null:+$('#costo').value,stock=+($('#stock').value||0),desc=$('#desc').value.trim(),slug=$('#slug').value||slugify(nombre),activo=$('#estado').value==='1';return{nombre,categoria,precio_venta:+precio.toFixed(2),costo:costo==null?null:+(+costo).toFixed(2),stock_actual:Math.max(0,Math.floor(stock)),descripcion_corta:desc.slice(0,160),slug,imagenes:imgBuf.map(x=>({src:x.src,type:x.type,primary:!!x.primary,name:x.name||null})),activo}}function validateUnique(nombre,skipId){const lc=nombre.toLowerCase();return !ART.some(a=>a.nombre.toLowerCase()===lc&&(skipId? a.id!==skipId:true))}fm.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();fm.requestSubmit()}});fm.onsubmit=e=>{e.preventDefault();const a=formObj();if(!a.nombre){msg('Nombre requerido');return}if(!validateUnique(a.nombre,editing)){msg('Nombre duplicado');return}if(!(a.precio_venta>=0)&&a.precio_venta!==0){msg('Precio inválido');return}if(a.costo!=null&&!(a.costo>=0)){msg('Costo inválido');return}if(!(a.stock_actual>=0)){msg('Stock inválido');return}let rec;if(editing){rec=ART.find(x=>x.id===editing);Object.assign(rec,a)}else{rec={id:uuid(),fecha_creacion:new Date().toISOString(),...a};ART.push(rec)}saveART();ensureCats();renderList();fillMovArt();toast('Artículo guardado');clearForm();setTab('s')};function clearForm(){fm.reset();$('#slug').value='';$('#aid').value='';editing=null;imgBuf=[];renderImgs()}clear.onclick=()=>{clearForm();toast('Formulario limpio');hint(clear)};exportOne.onclick=()=>{const a=editing?ART.find(x=>x.id===editing):{id:"temp",fecha_creacion:new Date().toISOString(),...formObj()};const blob=new Blob([JSON.stringify(a)],{type:'application/json'});const ael=document.createElement('a');ael.href=URL.createObjectURL(blob);ael.download=(a.slug||'articulo')+'.json';ael.click();toast('JSON descargado');hint(exportOne)};btnExportAll.onclick=()=>{const blob=new Blob([JSON.stringify(ART)],{type:'application/json'});const ael=document.createElement('a');ael.href=URL.createObjectURL(blob);ael.download='catalogo.json';ael.click();toast('Catálogo JSON descargado');hint(btnExportAll)};function renderList(){const q=$('#q').value.trim().toLowerCase(),cat=$('#fcat').value,est=$('#fest').value;const dupMap={};ART.forEach(a=>{const n=a.nombre.toLowerCase();dupMap[n]=(dupMap[n]||0)+1});const filtered=ART.filter(a=>{const hit=a.nombre.toLowerCase().includes(q)||(a.descripcion_corta||'').toLowerCase().includes(q)||(a.slug||'').toLowerCase().includes(q);const cOk=!cat||a.categoria===cat;const eOk=!est||(+a.activo===+est);return hit&&cOk&&eOk});const needPag=filtered.length>200,ps=parseInt($('#pageSize').value||'100',10),pages=Math.max(1,Math.ceil(filtered.length/ps));if(CUR.page>pages)CUR.page=pages;$('#pager').style.display=needPag?'flex':'none';$('#pgInfo').textContent=pages>1?`${CUR.page}/${pages} (${Math.min(ps,filtered.length-((CUR.page-1)*ps))} de ${filtered.length})`:`${filtered.length} ítems`;const start=(CUR.page-1)*ps;const slice=needPag?filtered.slice(start,start+ps):filtered.slice();const cats=[...new Set(slice.map(a=>a.categoria||'Sin categoría'))].sort();const tb=$('#tbl tbody');tb.innerHTML='';cats.forEach(c=>{tb.insertAdjacentHTML('beforeend',`<tr class=grp><td colspan=8>${c||'Sin categoría'}</td></tr>`);slice.filter(a=>(a.categoria||'Sin categoría')===c).forEach(a=>{const dup=dupMap[a.nombre.toLowerCase()]>1;const tr=document.createElement('tr');tr.dataset.id=a.id;if(dup)tr.classList.add('dup');tr.innerHTML=`<td>${a.nombre}${dup?" <span class=tag warn>Duplicado</span>":''}</td><td>${a.categoria||''}</td><td>${a.stock_actual}</td><td>${fmtMoney(a.precio_venta)}</td><td>${fmtDate(a.fecha_creacion)}</td><td>${(a.imagenes||[]).length}</td><td><span class="tag ${a.activo?'ok':'bad'}">${a.activo?'Activo':'Inactivo'}</span></td><td><div class=row><div class=act><button data-k=ed data-id=${a.id} data-hint="Editar">Editar</button><button data-k=cp data-id=${a.id} data-hint="Duplicar">Duplicar</button><button data-k=rm data-id=${a.id} data-hint="Eliminar">Eliminar</button></div></div></td>`;tb.appendChild(tr)})});$('#dupBadge').style.display=Object.values(dupMap).some(v=>v>1)?'inline-flex':'none';CUR.visIds=$$('#tbl tbody tr[data-id]').map(tr=>tr.dataset.id);applySelection()}pgPrev.onclick=()=>{if(CUR.page>1){CUR.page--;renderList()}};pgNext.onclick=()=>{CUR.page++;renderList()};pageSize.onchange=()=>{CUR.page=1;renderList()};$('#q').oninput=()=>{CUR.page=1;renderList();hint(q)};$('#fcat').onchange=()=>{CUR.page=1;renderList();hint(fcat)};$('#fest').onchange=()=>{CUR.page=1;renderList();hint(fest)};$('#tbl').onclick=e=>{const b=e.target.closest('button');if(!b)return;const id=b.dataset.id;const a=ART.find(x=>x.id===id);if(b.dataset.k==='ed'){loadToForm(a);toast('Editando')}if(b.dataset.k==='cp'){const base=a.nombre;let n=base+" (copia)";let i=2;while(!validateUnique(n))n=base+` (copia ${i++})`;const dup={...a,id:uuid(),nombre:n,slug:slugify(n),fecha_creacion:new Date().toISOString(),activo:false};ART.push(dup);saveART();renderList();toast('Duplicado')}if(b.dataset.k==='rm'){if(confirm('¿Eliminar artículo?')){const i=ART.findIndex(x=>x.id===id);ART.splice(i,1);saveART();renderList();fillMovArt();toast('Eliminado')}}hint(b)};function loadToForm(a){setTab('c');editing=a.id;$('#aid').value=a.id;$('#nombre').value=a.nombre;$('#categoria').value=a.categoria||'';$('#precio').value=(+a.precio_venta).toFixed(2);$('#costo').value=a.costo==null?'':(+a.costo).toFixed(2);$('#stock').value=a.stock_actual;$('#desc').value=a.descripcion_corta||'';$('#slug').value=a.slug||slugify(a.nombre);$('#estado').value=a.activo?1:0;imgBuf=(a.imagenes||[]).map(x=>({...x}));if(imgBuf.length&&!imgBuf.some(x=>x.primary))imgBuf[0].primary=true;renderImgs()}function fillMovArt(){const s=$('#movArt');s.innerHTML=ART.map(a=>`<option value="${a.id}">${a.nombre}</option>`).join('')}fillMovArt();movArt.onchange=()=>{const a=ART.find(x=>x.id===movArt.value);if(a){movPU.value=(+a.precio_venta).toFixed(2);toast('Precio sugerido aplicado')}};$('#movDate').value=today();$('#dfrom').value='';$('#dto').value='';$('#quick').onclick=e=>{if(e.target.tagName!=='BUTTON')return;const per=e.target.dataset.per;const now=new Date();let from,to=new Date();if(per==='day'){from=new Date();from.setHours(0,0,0,0)}if(per==='week'){from=new Date();const d=(now.getDay()||7)-1;from.setDate(now.getDate()-d);from.setHours(0,0,0,0)}if(per==='month'){from=new Date(now.getFullYear(),now.getMonth(),1)}$('#dfrom').value=from.toISOString().slice(0,10);$('#dto').value=to.toISOString().slice(0,10);renderMovUI();toast('Filtro rápido')};$('#applyPer').onclick=e=>{e.preventDefault();renderMovUI();toast('Rango aplicado');hint(applyPer)};fmov.onsubmit=e=>{e.preventDefault();const id=$('#movArt').value,tipo=$('#movTipo').value,cant=+($('#movCant').value||1),pu=+($('#movPU').value||0),fd=$('#movDate').value;if(!id||!(cant>0)||!(pu>=0)||!fd){movMsg.textContent='Datos inválidos';setTimeout(()=>movMsg.textContent='',1500);return}const art=ART.find(x=>x.id===id);MOV.push({id:uuid(),art:id,art_nombre:art.nombre,tipo,cantidad:Math.floor(cant),precio_unitario:+pu.toFixed(2),fecha:new Date(fd+'T00:00:00').toISOString()});if(tipo==='venta')art.stock_actual=Math.max(0,(art.stock_actual||0)-Math.floor(cant));else art.stock_actual=(art.stock_actual||0)+Math.floor(cant);saveMOV();saveART();renderMovUI();renderList();fillMovArt();fmov.reset();$('#movDate').value=today();$('#movPU').value=(+art.precio_venta).toFixed(2);toast('Movimiento registrado')};function rangeFilter(m){const df=$('#dfrom').value,dt=$('#dto').value;if(!df&&!dt)return m;const from=df?new Date(df+'T00:00:00'):new Date('1970-01-01'),to=dt?new Date(dt+'T23:59:59'):new Date('2999-12-31');return m.filter(x=>{const d=new Date(x.fecha);return d>=from&&d<=to})}function renderMovUI(){const mR=rangeFilter(MOV.slice().sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)));const tb=$('#tmov tbody');tb.innerHTML=mR.map(x=>`<tr><td>${fmtDate(x.fecha)}</td><td>${x.tipo}</td><td>${x.art_nombre}</td><td>${x.cantidad}</td><td>${fmtMoney(x.precio_unitario)}</td><td>${fmtMoney(x.cantidad*x.precio_unitario)}</td></tr>`).join('');const sum=(arr,fn)=>arr.reduce((s,it)=>s+fn(it),0);const v=sum(mR,f=>f.tipo==='venta'?f.cantidad*f.precio_unitario:0),i=sum(mR,f=>f.tipo==='ingreso'?f.cantidad*f.precio_unitario:0);$('#sVenta').textContent=fmtMoney(v);$('#sIngreso').textContent=fmtMoney(i);const now=new Date();const isSameDay=(a,b)=>a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()&&a.getDate()==b.getDate();const startOfWeek=()=>{const d=new Date();const s=(d.getDay()||7)-1;d.setDate(d.getDate()-s);d.setHours(0,0,0,0);return d};const startOfMonth=()=>new Date(now.getFullYear(),now.getMonth(),1);const mv=(pred)=>{const x=MOV.filter(m=>pred(new Date(m.fecha)));return[sum(x,f=>f.tipo==='venta'?f.cantidad*f.precio_unitario:0),sum(x,f=>f.tipo==='ingreso'?f.cantidad*f.precio_unitario:0)]};let [vh,ih]=mv(d=>isSameDay(d,now)),[vs,is2]=mv(d=>d>=startOfWeek()),[vm,im]=mv(d=>d>=startOfMonth());$('#tHoy').textContent=`V ${fmtMoney(vh)} • I ${fmtMoney(ih)}`;$('#tSem').textContent=`V ${fmtMoney(vs)} • I ${fmtMoney(is2)}`;$('#tMes').textContent=`V ${fmtMoney(vm)} • I ${fmtMoney(im)}`;renderStockRes()}function renderStockRes(){const cont=$('#stockres');cont.innerHTML=ART.map(a=>`<div class=card><div style=font-weight:600>${a.nombre}</div><div style=opacity:.7>Stock</div><div style=font-weight:700>${a.stock_actual}</div></div>`).join('')}function renderFilters(){ensureCats();$('#q').value='';$('#fcat').value='';$('#fest').value='';CUR.page=1;renderList()}q.placeholder='Buscar por nombre, descripción o slug';csvArt.onclick=()=>{const rows=[["id","nombre","categoria","precio_venta","costo","stock_actual","descripcion_corta","slug","fecha_creacion","imagenes","activo"],...ART.map(a=>[a.id,a.nombre,a.categoria,a.precio_venta,a.costo??'',a.stock_actual,a.descripcion_corta??'',a.slug,a.fecha_creacion,(a.imagenes||[]).map(i=>i.src).join('|'),a.activo?1:0])];downloadCSV(rows,'articulos.csv');toast('CSV de artículos')};csvMov.onclick=()=>{const rows=[["id","tipo","articulo_id","articulo_nombre","cantidad","precio_unitario","fecha"],...MOV.map(m=>[m.id,m.tipo,m.art,m.art_nombre,m.cantidad,m.precio_unitario,m.fecha])];downloadCSV(rows,'movimientos.csv');toast('CSV de movimientos')};function downloadCSV(rows,name){const esc=s=>`"${String(s).replace(/"/g,'""')}"`;const csv=rows.map(r=>r.map(esc).join(',')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click()}function hint(el){const t=el?.dataset?.hint||el?.title;if(t)toast(t)}help.onclick=()=>{$('#guide').style.display='grid';hint(help)};closeG.onclick=()=>{$('#guide').style.display='none';toast('Guía cerrada')};document.addEventListener('keydown',e=>{if(e.key==='Escape'&&$('#guide').style.display==='grid'){$('#guide').style.display='none';toast('Guía cerrada')}});document.addEventListener('keydown',e=>{if($('#secSalida').classList.contains('active')&&['ArrowDown','ArrowUp','Enter'].includes(e.key)&&!/(INPUT|TEXTAREA|SELECT)/.test(document.activeElement.tagName)){e.preventDefault();const rows=$$('#tbl tbody tr[data-id]');if(!rows.length)return;let idx=rows.findIndex(r=>r.classList.contains('sel'));if(idx<0)idx=0;if(e.key==='ArrowDown')idx=Math.min(rows.length-1,idx+1);if(e.key==='ArrowUp')idx=Math.max(0,idx-1);rows.forEach(r=>r.classList.remove('sel'));rows[idx].classList.add('sel');rows[idx].scrollIntoView({block:'nearest'});if(e.key==='Enter'){const id=rows[idx].dataset.id;const btn=rows[idx].querySelector('[data-k="ed"]');btn&&btn.click()}}});function applySelection(){const rows=$$('#tbl tbody tr[data-id]');rows.forEach(r=>r.classList.remove('sel'));if(rows[0])rows[0].classList.add('sel')}const numFix=[{sel:'#precio',fix:2,min:0,def:0},{sel:'#costo',fix:2,min:0,def:''},{sel:'#stock',fix:0,min:0,def:0},{sel:'#movCant',fix:0,min:1,def:1},{sel:'#movPU',fix:2,min:0,def:0}];numFix.forEach(n=>{const el=$(n.sel);el&&el.addEventListener('blur',()=>{let v=el.value.trim();if(v===''){el.value=n.def;return}v=v.replace(',','.');let x=+v;if(!(x>=0))x=n.def||0;x=Math.max(n.min,x);el.value=n.fix!=null?x.toFixed(n.fix):x})});const AUTHK='adm_auth',LOCKK='adm_lock',SESSK='adm_session';const enc=new TextEncoder;const toHex=b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');const fromHex=h=>new Uint8Array(h.match(/.{1,2}/g).map(b=>parseInt(b,16)));async function sha(s){const buf=await crypto.subtle.digest('SHA-256',s);return toHex(buf)}function saltHex(n=16){const b=new Uint8Array(n);crypto.getRandomValues(b);return toHex(b)}async function hashPass(p,saltH){const data=new Uint8Array([...fromHex(saltH),...enc.encode(p)]);return sha(data)}function sesSet(days){const exp=new Date(Date.now()+days*24*3600*1000).toISOString();const tok=uuid();localStorage.setItem(SESSK,JSON.stringify({tok,exp}))}function sesValid(){const raw=localStorage.getItem(SESSK);if(!raw)return false;try{const {exp}=JSON.parse(raw);return new Date(exp)>new Date()}catch{return false}}function lockInfo(){const r=localStorage.getItem(LOCKK);if(!r)return{until:0,f:0};try{const o=JSON.parse(r);return o}catch{return{until:0,f:0}}}function setLock(f){let {until}=lockInfo();if(f>=5)until=Date.now()+5*60*1000;localStorage.setItem(LOCKK,JSON.stringify({until,f}))}function resetLock(){localStorage.removeItem(LOCKK)}function showSetup(){authTitle.textContent='Configurar administrador';authSetup.classList.remove('hide');authLogin.classList.add('hide')}function showLogin(){authTitle.textContent='Iniciar sesión';authSetup.classList.add('hide');authLogin.classList.remove('hide')}async function initAuth(){if(sesValid()){$('#auth').style.display='none';return}const a=localStorage.getItem(AUTHK);$('#auth').style.display='grid';if(!a)showSetup();else showLogin()}authSetup.onsubmit=async e=>{e.preventDefault();const u=au.value.trim(),p=ap.value,pp=ap2.value;if(u.length<3){au.focus();return}if(p.length<6||p!==pp){ap.value='';ap2.value='';ap.focus();return}const s=saltHex(),h=await hashPass(p,s);localStorage.setItem(AUTHK,JSON.stringify({u,s,h,created:new Date().toISOString()}));resetLock();sesSet(0.33);$('#auth').style.display='none';toast('Administrador creado')};doLogin.onclick=async e=>{e.preventDefault();const {until,f}=lockInfo();if(until&&Date.now()<until){la.textContent='Bloqueado temporalmente';return}const a=JSON.parse(localStorage.getItem(AUTHK)||'{}');const u=lu.value.trim(),p=lp.value;const okUser=a.u&&u===a.u;const hp=await hashPass(p,a.s||'');const ok=okUser&&hp===a.h;if(ok){resetLock();sesSet(remember.checked?7:0.33);$('#auth').style.display='none';toast('Bienvenido')}else{setLock((f||0)+1);la.textContent='Credenciales inválidas'}};logout.onclick=()=>{localStorage.removeItem(SESSK);$('#auth').style.display='grid';showLogin();toast('Sesión cerrada')};impClose.onclick=()=>{$('#import').style.display='none'};btnImport.onclick=()=>{$('#import').style.display='grid'};impFile.onchange=async e=>{const f=e.target.files[0];if(!f)return;const ext=f.name.split('.').pop().toLowerCase();const txt=await f.text();if(ext==='csv'){IMP.type='csv';const delim=$('#impDelim').value;const parsed=csvParse(txt,delim);IMP.cols=parsed.shift()||[];IMP.rows=parsed.map(r=>{const o={};IMP.cols.forEach((c,i)=>o[c]=r[i]);return o})}else{IMP.type='json';let arr=[];try{const j=JSON.parse(txt);arr=Array.isArray(j)?j:(Array.isArray(j.items)?j.items:[])}catch{arr=[]}if(!arr.length){toast('JSON vacío o inválido');return}IMP.cols=[...new Set(arr.flatMap(o=>Object.keys(o)))];IMP.rows=arr}buildMapUI();buildPreview()};impDelim.onchange=()=>{if(IMP.type==='csv'&&impFile.files[0])impFile.onchange({target:impFile})};function buildMapUI(){const targets=["nombre","categoria","precio_venta","costo","stock_actual","descripcion_corta","slug","imagenes","activo"];const opts=[''].concat(IMP.cols);const mkSel=id=>`<select data-tgt="${id}">${opts.map(o=>`<option>${o}</option>`).join('')}</select>`;mapBox.innerHTML=targets.map(t=>`<label>${t.replace('_',' ')}${mkSel(t)}</label>`).join('');impDetect.onclick=()=>autoDetect();function autoDetect(){const syn={nombre:["nombre","name","titulo"],categoria:["categoria","category"],precio_venta:["precio_venta","precio","price","precio_ars"],costo:["costo","cost"],stock_actual:["stock_actual","stock","existencia","cantidad"],descripcion_corta:["descripcion_corta","descripcion","desc"],slug:["slug","url_slug"],imagenes:["imagenes","fotos","images","imgs","gallery","image"],activo:["activo","estado","enabled","is_active"]};const norm=s=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]/g,'');$$('#mapBox select').forEach(sel=>{const tgt=sel.dataset.tgt;const cands=syn[tgt]||[];const hit=IMP.cols.find(c=>cands.includes(norm(c)));if(hit)sel.value=hit})}}function buildPreview(){const cols=IMP.cols.slice(0,12);const rows=IMP.rows.slice(0,10);impPrev.innerHTML='<div style="font-weight:700;margin:6px 0">Vista previa</div><table><thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead><tbody>'+rows.map(r=>'<tr>'+cols.map(c=>`<td>${String(r[c]??'')}</td>`).join('')+'</tr>').join('')+'</tbody></table>'}impDo.onclick=()=>{if(!IMP.rows.length){toast('Nada para importar');return}const map={};$$('#mapBox select').forEach(s=>{if(s.value)map[s.dataset.tgt]=s.value});let imported=0,updated=0,skipped=0;const upd=$('#impUpdate').checked;IMP.rows.forEach(r=>{const g=(k)=>r[map[k]]??'';const nombre=(g('nombre')||'').toString().trim();if(!nombre){skipped++;return}const categoria=(g('categoria')||'').toString().trim();const precio=toNum(g('precio_venta'));const costoRaw=g('costo');const costo=costoRaw===''?null:toNum(costoRaw);const stock=Math.max(0,Math.floor(toNum(g('stock_actual'))));const descripcion=(g('descripcion_corta')||'').toString().trim().slice(0,160);const slug=(g('slug')||'').toString().trim()||slugify(nombre);const imgsStr=(g('imagenes')||'').toString();const activoVal=(g('activo')||'').toString().toLowerCase();const activo=['1','true','activo','si','sí','yes'].includes(activoVal);const imgs=imgsStr?imgsStr.split(/\||,/).map((u,i)=>({src:u.trim(),type:'url',primary:i==0})).filter(x=>x.src):[];const base={nombre,categoria,precio_venta:+(+precio).toFixed(2),costo:costo==null?null:+(+costo).toFixed(2),stock_actual:stock,descripcion_corta:descripcion,slug,imagenes:imgs,activo};const ex=ART.find(a=>a.nombre.toLowerCase()===nombre.toLowerCase());if(ex){if(upd){Object.assign(ex,base);updated++}else{skipped++}}else{ART.push({id:uuid(),fecha_creacion:new Date().toISOString(),...base});imported++}});saveART();ensureCats();renderList();fillMovArt();toast(`Importados ${imported} • Actualizados ${updated} • Omitidos ${skipped}`);$('#import').style.display='none'};function toNum(v){if(v==null||v==='')return 0;const s=String(v).replace(',','.').replace(/[^0-9.\-]/g,'');const x=+s;return isNaN(x)?0:x}function csvParse(s,delim=','){const re=new RegExp(`([^"${delim}\n\r]*|"(?:[^"]|"")*")(${delim}|\n|\r|$)`,'g');const out=[];let row=[],m;while((m=re.exec(s))){let val=m[1];const sep=m[2];if(val&&val[0]=='"'){val=val.slice(1,-1).replace(/""/g,'"')}row.push(val);if(sep===delim){continue}else{out.push(row);row=[];if(sep==='')break}}return out}document.addEventListener('keydown',e=>{if(e.key==='Escape'&&$('#import').style.display==='grid'){$('#import').style.display='none'}});const IMP={type:null,cols:[],rows:[],map:{}};function hintAuthRisk(){toast('Protección local; visible en código')}initAuth();</script></body></html>
